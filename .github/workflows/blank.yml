name: üîê Free SSH VPS via Ngrok (Stable Final v3)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ‚úÖ Setup SSH Server
      run: |
        sudo apt update
        sudo apt install -y openssh-server curl unzip
        echo "root:password" | sudo chpasswd
        sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
        sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo systemctl enable ssh
        sudo systemctl start ssh
        sudo systemctl restart ssh

    - name: üåê Install Ngrok & Start TCP Tunnel
      run: |
        curl -s -L https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip -o ngrok.zip
        unzip ngrok.zip
        chmod +x ngrok
        ./ngrok authtoken 2ytjV8Op4vrrttvTrEJiQLEDi5I_dwsosxpuvCSo4dLqd9P1
        nohup ./ngrok tcp 22 --log=stdout > ngrok.log 2>&1 &
        sleep 15

    - name: ‚è≥ Wait for tunnel and show SSH login
      run: |
        echo "‚è≥ Waiting for ngrok tunnel to be ready..."

        for i in {1..15}; do
          TUNNEL_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'tcp://[0-9a-zA-Z\.:]*')
          if [[ ! -z "$TUNNEL_URL" ]]; then
            echo "üéâ Tunnel found!"
            break
          fi
          echo "‚åõ Still waiting... ($i)"
          sleep 4
        done

        if [[ -z "$TUNNEL_URL" ]]; then
          echo "‚ùå Failed to get tunnel from ngrok. Exiting."
          cat ngrok.log
          exit 1
        fi

        echo "=============================="
        echo "‚úÖ SSH VPS IS READY!"
        echo "üîê SSH Login Command:"
        echo "üëâ ssh root@$(echo $TUNNEL_URL | sed 's/tcp:\/\///' | sed 's/:/ -p /')"
        echo "üõ°Ô∏è Password: password"
        echo "=============================="
