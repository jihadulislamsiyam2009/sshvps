name: Free VPS via SSH and Ngrok

on: 
  workflow_dispatch:

jobs:
  ssh-vps:
    runs-on: ubuntu-latest

    steps:
    - name: Set up SSH server
      run: |
        sudo apt update
        sudo apt install -y openssh-server curl unzip
        sudo systemctl enable ssh
        sudo systemctl start ssh
        echo "root:password" | sudo chpasswd
        sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
        sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo service ssh restart

    - name: Download & Setup Ngrok from ZIP (Manual Way)
      run: |
        wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip -O ngrok.zip
        unzip ngrok.zip
        chmod +x ngrok
        sudo mv ngrok /usr/local/bin
        ngrok config add-authtoken 2ytjV8Op4vrrttvTrEJiQLEDi5I_dwsosxpuvCSo4dLqd9P1
        nohup ngrok tcp 22 &

    - name: Show SSH login command
      run: |
        sleep 10
        curl -s http://127.0.0.1:4040/api/tunnels > tunnel.json
        echo "=============================="
        echo "ğŸ”‘ SSH Login Command:"
        cat tunnel.json | grep -o 'tcp://[0-9a-zA-Z\.:]*' | sed 's/tcp:\/\///' | while read line; do
          echo "ğŸ‘‰ ssh root@$(echo $line | sed 's/:/ -p /')"
        done
        echo "ğŸ›¡ï¸ Password: password"
        echo "=============================="
